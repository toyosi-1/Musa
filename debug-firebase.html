<!DOCTYPE html>
<html>
<head>
    <title>Firebase Debug Tool</title>
    <script type="module">
        // Paste your Firebase config here
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            databaseURL: "YOUR_DATABASE_URL",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, get, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.testFirebase = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const output = document.getElementById('output');
            output.innerHTML = 'Testing...<br>';

            try {
                // Test 1: Login
                output.innerHTML += '1. Logging in...<br>';
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                output.innerHTML += `✅ Logged in as: ${user.email} (UID: ${user.uid})<br>`;

                // Test 2: Read own user profile
                output.innerHTML += '<br>2. Reading own user profile...<br>';
                const userRef = ref(db, `users/${user.uid}`);
                const userSnap = await get(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    output.innerHTML += `✅ User data found<br>`;
                    output.innerHTML += `- Role: ${userData.role}<br>`;
                    output.innerHTML += `- Email: ${userData.email}<br>`;
                    output.innerHTML += `- Status: ${userData.status}<br>`;
                    output.innerHTML += `- Estate ID: ${userData.estateId || 'none'}<br>`;
                } else {
                    output.innerHTML += `❌ User profile not found in database!<br>`;
                }

                // Test 3: Query pending users (admin only)
                output.innerHTML += '<br>3. Querying pending users...<br>';
                const usersRef = ref(db, 'users');
                const pendingQuery = query(usersRef, orderByChild('status'), equalTo('pending'));
                const pendingSnap = await get(pendingQuery);
                
                if (pendingSnap.exists()) {
                    const count = Object.keys(pendingSnap.val()).length;
                    output.innerHTML += `✅ Found ${count} pending user(s)<br>`;
                    pendingSnap.forEach(childSnap => {
                        const u = childSnap.val();
                        output.innerHTML += `- ${u.email} (${u.role})<br>`;
                    });
                } else {
                    output.innerHTML += `⚠️ No pending users found<br>`;
                }

                // Test 4: Read estates
                output.innerHTML += '<br>4. Reading estates...<br>';
                const estatesRef = ref(db, 'estates');
                const estatesSnap = await get(estatesRef);
                if (estatesSnap.exists()) {
                    const count = Object.keys(estatesSnap.val()).length;
                    output.innerHTML += `✅ Found ${count} estate(s)<br>`;
                } else {
                    output.innerHTML += `❌ No estates found<br>`;
                }

                output.innerHTML += '<br>✅ All tests completed!';

            } catch (error) {
                output.innerHTML += `<br>❌ ERROR: ${error.code}<br>`;
                output.innerHTML += `Message: ${error.message}<br>`;
                console.error('Full error:', error);
            }
        };
    </script>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        input { width: 100%; padding: 8px; margin: 5px 0; }
        button { padding: 10px 20px; background: #4285f4; color: white; border: none; cursor: pointer; }
        #output { background: #f5f5f5; padding: 15px; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Firebase Debug Tool</h1>
    <p>This will test your Firebase connection and permissions.</p>
    
    <label>Admin Email:</label>
    <input type="email" id="email" placeholder="admin@example.com">
    
    <label>Password:</label>
    <input type="password" id="password" placeholder="password">
    
    <button onclick="testFirebase()">Run Tests</button>
    
    <div id="output"></div>
    
    <h3>Instructions:</h3>
    <ol>
        <li>Open .env.local file and copy your Firebase credentials</li>
        <li>Paste them into the firebaseConfig object at the top of this file</li>
        <li>Open this HTML file in your browser</li>
        <li>Enter your admin credentials and click "Run Tests"</li>
        <li>Share the output with me</li>
    </ol>
</body>
</html>
